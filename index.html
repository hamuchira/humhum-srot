<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã¯ã‚€ã¯ã‚€ã‚¹ãƒ­ãƒƒãƒˆ</title>
<style>
  :root {
    --cell: 120px;      /* 1ã‚³ãƒã®é«˜ã• */
    --reel-w: 120px;    /* ãƒªãƒ¼ãƒ«ã®å¹… */
    --gap: 12px;
  }
  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto;
    margin: 0; padding: 24px;
    background: #f7fbff;
    color: #234;
  }
  h1 { margin: 0 0 8px; font-size: 22px; }
  .wrap {
    max-width: 480px; margin: 0 auto;
  }
  .panel {
    background: #fff; border-radius: 14px; padding: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,.08);
    margin-bottom: 14px;
  }
  .hud { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center; }
  .hud .money { font-weight: 700; }
  .controls { display: flex; gap: 8px; flex-wrap: wrap; }
  button, select {
    border: 0; padding: 10px 14px; border-radius: 10px;
    background: #4facfe; color: white; font-weight: 700; cursor: pointer;
  }
  button:disabled { opacity: .5; cursor: not-allowed; }
  select, .pill {
    background: #eef6ff; color: #234; border: 1px solid #d7e9ff;
  }
  .machine {
    position: relative; padding: 16px; border-radius: 16px;
    background: linear-gradient(180deg,#eaf3ff,#d9ebff);
    border: 2px solid #cde2ff;
  }
  .reels {
    display: grid; grid-template-columns: var(--reel-w) var(--reel-w) var(--reel-w);
    gap: var(--gap); justify-content: center;
    padding: 12px; background: #fff; border-radius: 14px;
    box-shadow: inset 0 2px 12px rgba(0,0,0,.06);
  }
  .reel {
    width: var(--reel-w);
    height: calc(var(--cell) * 3); /* 3æ®µè¡¨ç¤º */
    overflow: hidden; border-radius: 10px; background: #f2f7ff;
    border: 1px solid #e2efff; position: relative;
  }
  .strip {
    position: absolute; width: 100%; will-change: transform;
  }
  .cell {
    width: 100%; height: var(--cell);
    display: grid; place-items: center;
    background: #fff;
  }
  .cell img {
    width: 100%; height: 100%; object-fit: cover; display: block;
    user-select: none; -webkit-user-drag: none; pointer-events: none;
  }
  .lines {
    text-align: center; margin-top: 8px; font-size: 12px; color: #456;
  }
  .stops { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
  .result { text-align: center; font-weight: 800; padding: 8px; }
  .result.win { color: #0a8; }
  .result.lose { color: #a05; }
  .pay { font-size: 12px; color: #345; line-height: 1.4; }
</style>
</head>
<body>
<div class="wrap">
  <h1>ã¯ã‚€ã¯ã‚€ã‚¹ãƒ­ãƒƒãƒˆ ğŸ°</h1>

  <div class="panel hud">
    <div class="money">ğŸ’° ã‚³ã‚¤ãƒ³ï¼š<span id="coins">100</span></div>
    <div class="controls">
      <label class="pill">BETï¼š
        <select id="bet">
          <option>1</option><option>2</option><option>3</option><option>4</option><option selected>5</option>
          <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
        </select>
      </label>
      <button id="startBtn">Start</button>
    </div>
  </div>

  <div class="panel machine">
    <div class="reels" id="reels"></div>
    <div class="stops">
      <button id="stop1" disabled>STOPâ‘ </button>
      <button id="stop2" disabled>STOPâ‘¡</button>
      <button id="stop3" disabled>STOPâ‘¢</button>
    </div>
    <div class="lines">æœ‰åŠ¹ãƒ©ã‚¤ãƒ³ï¼šæ¨ª3æœ¬ï¼‹æ–œã‚2æœ¬ï¼ˆè¨ˆ5ãƒ©ã‚¤ãƒ³ï¼‰</div>
  </div>

  <div class="panel result" id="result">READY</div>
  <div class="panel pay">
    <strong>é…å½“ï¼ˆ3ã¤æƒã„ï¼ãƒ©ã‚¤ãƒ³ï¼‰</strong><br>
    æ­£é¢é¡”Ã—3 = BETÃ—6 ï¼ ã¯ã‚€ã‚±ãƒ„Ã—3 = BETÃ—8 ï¼ ã­ã‚€ã­ã‚€Ã—3 = BETÃ—5 ï¼ ã”ã¯ã‚“Ã—3 = BETÃ—5 ï¼
    å›ã—è»ŠÃ—3 = BETÃ—7 ï¼ ã‚ãã³Ã—3 = BETÃ—10ï¼ˆãƒ¬ã‚¢ï¼‰ ï¼ å…„å¼ŸÃ—3 = BETÃ—12ï¼ˆãƒ¬ã‚¢ï¼‰
  </div>
</div>

<script>
/* =======================
   è¨­å®š
======================= */
// ã“ã“ã‚’ã‚ãªãŸã®å†™çœŸã«å·®ã—æ›¿ãˆ
const SYMBOLS = [
  { id: 'front',   img: 'assets/ham1.png',  mul: 6 },
  { id: 'ketsu',   img: 'assets/ham2.png',  mul: 8 },
  { id: 'sleep',   img: 'assets/ham3.png',  mul: 5 },
  { id: 'eat',     img: 'assets/ham4.png',  mul: 5 },
  { id: 'wheel',   img: 'assets/ham5.png',  mul: 7 },
  { id: 'yawn',    img: 'assets/ham6.png',  mul: 10 }, // ãƒ¬ã‚¢
  { id: 'bros',    img: 'assets/ham7.png',  mul: 12 }  // ãƒ¬ã‚¢
];
// 1ã‚³ãƒã®é«˜ã•ï¼ˆCSSã¨åˆã‚ã›ã‚‹ï¼‰
const CELL_H = 120;
// å›è»¢é€Ÿåº¦ï¼ˆpx/ç§’ï¼‰ é«˜é€Ÿâ†’æ¸›é€Ÿ
const SPEED_HIGH = 1800;
const FRICTION = 0.965;      // æ¸›é€Ÿç‡(æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å€ç‡)
const STOP_THRESHOLD = 150;  // ã“ã‚Œä»¥ä¸‹ã«ãªã£ãŸã‚‰åœæ­¢èª¿æ•´ã«ç§»è¡Œ
const SNAP_SPEED = 0.92;     // ã‚¹ãƒŠãƒƒãƒ—æ™‚ã®æ¸›è¡°
const REPEAT_STRIP = 3;      // ã‚¹ãƒˆãƒªãƒƒãƒ—ã‚’ç¹°ã‚Šè¿”ã™å›æ•°ï¼ˆãƒ«ãƒ¼ãƒ—è¦‹ã›ç”¨ï¼‰

/* =======================
   çŠ¶æ…‹
======================= */
let coins = 100;
let betEl = document.getElementById('bet');
let coinsEl = document.getElementById('coins');
let resultEl = document.getElementById('result');
let startBtn = document.getElementById('startBtn');
let stopBtns = [document.getElementById('stop1'), document.getElementById('stop2'), document.getElementById('stop3')];
let reelsRoot = document.getElementById('reels');

coinsEl.textContent = coins;

function preload(images) {
  images.forEach(src => { const i = new Image(); i.src = src; });
}
preload(SYMBOLS.map(s => s.img));

/* =======================
   ãƒªãƒ¼ãƒ«ç”Ÿæˆ
======================= */
class Reel {
  constructor(index) {
    this.index = index;
    this.el = document.createElement('div');
    this.el.className = 'reel';

    this.strip = document.createElement('div');
    this.strip.className = 'strip';
    this.el.appendChild(this.strip);

    // ã‚¹ãƒˆãƒªãƒƒãƒ—å†…å®¹ï¼ˆç¹°ã‚Šè¿”ã—ã§é•·ãã™ã‚‹ï¼‰
    for (let r = 0; r < REPEAT_STRIP; r++) {
      SYMBOLS.forEach(sym => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        const img = document.createElement('img');
        img.src = sym.img;
        img.alt = sym.id;
        cell.appendChild(img);
        this.strip.appendChild(cell);
      });
    }

    this.totalCells = SYMBOLS.length * REPEAT_STRIP;
    this.totalH = this.totalCells * CELL_H;

    // çŠ¶æ…‹
    this.pos = Math.random() * this.totalH; // ç¾åœ¨ä½ç½®ï¼ˆpxï¼‰
    this.v = 0;          // é€Ÿåº¦(px/s)
    this.state = 'idle'; // 'idle' | 'spin' | 'stopping' | 'snapping' | 'stopped'
    this.wantStop = false;
  }

  start() {
    this.v = SPEED_HIGH;
    this.state = 'spin';
    this.wantStop = false;
  }

  requestStop() {
    if (this.state === 'spin') {
      this.state = 'stopping';
      this.wantStop = true;
    }
  }

  update(dt) {
    // dt: ç§’
    if (this.state === 'spin') {
      // ã²ãŸã™ã‚‰é«˜é€Ÿã§å›ã‚Šç¶šã‘ã‚‹
      this.pos = (this.pos + this.v * dt) % this.totalH;
    } else if (this.state === 'stopping') {
      // æ¸›é€Ÿãƒ•ã‚§ãƒ¼ã‚º
      this.v *= Math.pow(FRICTION, (dt * 60)); // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆä¾å­˜ã‚’è»½æ¸›
      this.pos = (this.pos + this.v * dt) % this.totalH;
      if (this.v < STOP_THRESHOLD) {
        // è¿‘ã„ã‚»ãƒ«ä½ç½®ã¸ã‚¹ãƒŠãƒƒãƒ—
        this.state = 'snapping';
      }
    } else if (this.state === 'snapping') {
      // ã´ã£ãŸã‚Šç›®ã«å¸ã„è¾¼ã¾ã‚Œã‚‹æ¼”å‡ºï¼šæœ€å¯„ã‚Šã‚»ãƒ«å¢ƒç•Œã¸åæŸ
      const off = this.pos % CELL_H; // 0..CELL_H
      let targetDelta = (off < CELL_H/2) ? -off : (CELL_H - off);
      // å°‘ã—ãšã¤å¯„ã›ã‚‹
      targetDelta *= (1 - SNAP_SPEED);
      this.pos = (this.pos + targetDelta) % this.totalH;

      // ã»ã¼å¢ƒç•Œã«æ¥ãŸã‚‰åœæ­¢
      if (Math.abs(this.pos % CELL_H) < 0.5 || Math.abs((this.pos % CELL_H) - CELL_H) < 0.5) {
        // ç«¯æ•°åˆ‡ã‚Šæ¨ã¦
        this.pos = Math.round(this.pos / CELL_H) * CELL_H;
        this.state = 'stopped';
        this.v = 0;
      }
    }
    this.render();
  }

  render() {
    // translateYã¯ãƒã‚¤ãƒŠã‚¹ã§ä¸Šã¸
    this.strip.style.transform = `translateY(${-this.pos % this.totalH}px)`;
  }

  isStopped() {
    return this.state === 'stopped';
  }

  visibleIndices() {
    // ä¸Šã‹ã‚‰3ã‚»ãƒ«åˆ†ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆä¸­å¤®åŸºæº–ã«ã—ãŸã‘ã‚Œã°èª¿æ•´ã—ã¦OKï¼‰
    // ã“ã“ã§ã¯ç¾åœ¨ã®posã®ã€Œå…ˆé ­ã‚»ãƒ«ã€ã‚’ top ã¨ã—ã¦ 3 ã¤è¿”ã™
    const topIdx = Math.floor(this.pos / CELL_H) % this.totalCells;
    const i0 = (topIdx) % this.totalCells;
    const i1 = (topIdx + 1) % this.totalCells;
    const i2 = (topIdx + 2) % this.totalCells;
    // å…ƒé…åˆ—ã®ã©ã®ã‚·ãƒ³ãƒœãƒ«ã‹ï¼ˆç¹°ã‚Šè¿”ã—ã®ä¸­ã«ã‚ã‚‹ã®ã§ mod SYMBOLS.lengthï¼‰
    return [i0, i1, i2].map(i => i % SYMBOLS.length);
  }
}

const reels = [new Reel(0), new Reel(1), new Reel(2)];
reels.forEach(r => reelsRoot.appendChild(r.el));

/* =======================
   ã‚²ãƒ¼ãƒ é€²è¡Œ
======================= */
let raf = null;
let last = 0;

function loop(ts) {
  if (!last) last = ts;
  const dt = (ts - last) / 1000;
  last = ts;

  reels.forEach(r => r.update(dt));

  raf = requestAnimationFrame(loop);
}

function enableStops(on) {
  stopBtns.forEach(b => b.disabled = !on);
}

function allStopped() {
  return reels.every(r => r.isStopped());
}

function startSpin() {
  const bet = parseInt(betEl.value, 10);
  if (coins < bet) {
    showResult('ã‚³ã‚¤ãƒ³ä¸è¶³ğŸ¥²', false);
    return;
  }
  coins -= bet;
  coinsEl.textContent = coins;

  // ãƒªãƒ¼ãƒ«é–‹å§‹
  reels.forEach(r => r.start());
  startBtn.disabled = true;
  enableStops(true);
  showResult('SPINNING...', null);

  // ãƒ«ãƒ¼ãƒ—é–‹å§‹
  if (!raf) { last = 0; raf = requestAnimationFrame(loop); }
}

function stopReel(i) {
  reels[i].requestStop();
  // 3ã¤æ­¢ã¾ã£ãŸã‚‰ç²¾ç®—
  if (allStopped()) {
    settle();
  }
}

function settle() {
  // å°‘ã—ä½™è£•ã‚’è¦‹ã¦ã€å®Œå…¨åœæ­¢ã‚’å¾…ã¤
  const wait = () => {
    if (!allStopped()) return setTimeout(wait, 80);
    enableStops(false);
    startBtn.disabled = false;

    // ç›¤é¢å–å¾—ï¼ˆå„ãƒªãƒ¼ãƒ«ã®è¦‹ãˆã¦ã„ã‚‹3ã‚»ãƒ«ï¼‰
    // è¡Œã”ã¨ã«ãƒ©ã‚¤ãƒ³ã‚’ä½œã‚‹ãŸã‚ã€row=0..2, col=0..2 ã®idé…åˆ—ã‚’ä½œã‚‹
    const board = Array.from({length:3}, ()=>Array(3).fill(null));
    for (let col=0; col<3; col++) {
      const vis = reels[col].visibleIndices(); // ä¸Šã‹ã‚‰3ã¤
      for (let row=0; row<3; row++) {
        board[row][col] = SYMBOLS[vis[row]].id;
      }
    }

    // ãƒ©ã‚¤ãƒ³å®šç¾©ï¼ˆæ¨ª3ï¼‹æ–œã‚2ï¼‰
    const lines = [
      [[0,0],[0,1],[0,2]],
      [[1,0],[1,1],[1,2]],
      [[2,0],[2,1],[2,2]],
      [[0,0],[1,1],[2,2]],
      [[2,0],[1,1],[0,2]],
    ];

    const bet = parseInt(betEl.value, 10);
    let win = 0;

    for (const line of lines) {
      const ids = line.map(([r,c]) => board[r][c]);
      if (ids[0] === ids[1] && ids[1] === ids[2]) {
        const sym = SYMBOLS.find(s => s.id === ids[0]);
        win += bet * (sym?.mul ?? 1);
      }
    }

    if (win > 0) {
      coins += win;
      coinsEl.textContent = coins;
      showResult(`WIN! +${win}æš`, true);
    } else {
      showResult('No win...', false);
    }
  };
  wait();
}

function showResult(msg, isWin) {
  resultEl.textContent = msg;
  resultEl.classList.remove('win','lose');
  if (isWin === true) resultEl.classList.add('win');
  if (isWin === false) resultEl.classList.add('lose');
}

/* =======================
   ã‚¤ãƒ™ãƒ³ãƒˆ
======================= */
startBtn.addEventListener('click', startSpin);
stopBtns[0].addEventListener('click', ()=>stopReel(0));
stopBtns[1].addEventListener('click', ()=>stopReel(1));
stopBtns[2].addEventListener('click', ()=>stopReel(2));

/* =======================
   åˆæœŸæç”»
======================= */
reels.forEach(r => r.render());
</script>
</body>
</html>
