<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>はむはむスロット</title>
<style>
  :root{ --gap:10px; --reel-w:110px; --cell:110px; --bord:#3a0014; }
  *{box-sizing:border-box}
  body{margin:0;padding:10px 10px 160px;background:#fee9f1;font-family:system-ui,-apple-system,'Segoe UI',Roboto;color:#1f2530}
  a{text-decoration:none}
  .cabinet{max-width:560px;margin:0 auto 100px;background:linear-gradient(#8f0030,#b50039 30%,#7a0022);border:5px solid var(--bord);border-radius:16px;padding:10px;color:#fff;box-shadow:0 12px 28px rgba(0,0,0,.25)}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
  .title{margin:0;font-size:18px;letter-spacing:.02em;text-shadow:0 2px 4px rgba(0,0,0,.35)}
  .pillBtns{display:flex;gap:8px}
  .miniBtn{border:0;padding:8px 12px;border-radius:12px;font-weight:800;cursor:pointer;background:linear-gradient(#ffd561,#e6b44b);color:#3b2a00;box-shadow:0 3px 0 #9b7d32}
  .window{background:#fff;border-radius:12px;padding:10px;overflow:hidden}
  .reels{display:grid;grid-template-columns:repeat(3,var(--reel-w));gap:var(--gap);justify-content:center;min-height:calc(var(--cell)*3 + var(--gap)*2)}
  .reel{width:var(--reel-w);height:calc(var(--cell)*3);overflow:hidden;border:2px solid #d9d9d9;border-radius:10px;position:relative;background:#f5f8ff;margin:0 auto}
  .strip{position:absolute;width:100%;will-change:transform}
  .cell{width:var(--reel-w);height:var(--cell);display:grid;place-items:center;background:#fff}
  .cell img{width:100%;height:100%;object-fit:contain;padding:6px;user-select:none;-webkit-user-drag:none;pointer-events:none}
  .meter{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .chip{background:#111;color:#73ffda;border:1px solid #000;border-radius:10px;padding:6px 8px;font-family:ui-monospace,monospace;text-align:center;box-shadow:inset 0 0 10px rgba(0,255,180,.25)}
  .chip .lbl{font-size:10px;opacity:.85;display:block}
  .chip .val{font-size:14px;font-weight:800}
  .ctrl{display:grid;gap:10px;margin-top:8px}
  .betrow{display:grid;grid-template-columns:auto 1fr auto auto;gap:8px;align-items:center}
  .seg{min-width:90px;text-align:center;padding:8px;border-radius:10px;background:#111;color:#73ffda;border:1px solid #000;font-family:ui-monospace,monospace;box-shadow:inset 0 0 10px rgba(0,255,180,.25)}
  .btn{border:0;cursor:pointer;color:#fff;font-weight:900;padding:12px;border-radius:12px;background:linear-gradient(#ff6b8b,#e82855);box-shadow:0 4px 0 #8b0e2b,0 8px 12px rgba(0,0,0,.2)}
  .btn.gold{background:linear-gradient(#ffd561,#e6b44b);color:#3b2a00;box-shadow:0 4px 0 #9b7d32, 0 8px 12px rgba(0,0,0,.2)}
  .btn.blue{background:linear-gradient(#7ec3ff,#2b75ff);box-shadow:0 4px 0 #1f4bb3, 0 8px 12px rgba(0,0,0,.2)}
  .btn:active{transform:translateY(2px)}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .full{grid-column:1/-1}
  .dock{position:fixed;left:0;right:0;bottom:env(safe-area-inset-bottom);display:flex;justify-content:center;pointer-events:none;z-index:5}
  .homeBtn{pointer-events:auto;display:flex;align-items:center;gap:10px;background:linear-gradient(#ffd561,#e6b44b);color:#3b2a00;border:none;border-radius:999px;padding:16px 22px;font-weight:900;box-shadow:0 10px 26px rgba(0,0,0,.25);transform:translateY(-10px)}
  .homeBtn .icon{font-size:20px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:20px;z-index:10}
  .modal.show{display:flex}
  .sheet{width:min(560px,92vw);max-height:80vh;overflow:auto;background:linear-gradient(#fff,#f7f7f7);border-radius:14px;padding:12px 12px 16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .sheet h2{margin:0 0 8px;font-size:18px;color:#222}
  .paytable,.prizes{display:grid;grid-template-columns:1fr auto;gap:8px 10px}
  .row{background:#fff;border:1px solid #eee;border-radius:10px;padding:8px 10px;display:flex;justify-content:space-between}
  .mul{color:#d22;font-weight:900}
  .close{margin-top:12px;width:100%}
  .goStore{display:block;margin:10px auto 8px;width:min(360px,80%)}
</style>
</head>
<body>
  <div class="cabinet">
    <div class="topbar">
      <h1 class="title">はむはむスロット 🎰</h1>
      <div class="pillBtns">
        <button class="miniBtn" id="openPay">配当表</button>
        <button class="miniBtn" id="openPrizes">景品一覧</button>
      </div>
    </div>

    <div class="window"><div class="reels" id="reels"></div></div>

    <div class="meter">
      <div class="chip"><span class="lbl">CREDIT</span><span class="val" id="credit">100</span></div>
      <div class="chip"><span class="lbl">BET</span><span class="val" id="betDisp">5</span></div>
      <div class="chip"><span class="lbl">PAID</span><span class="val" id="paid">0</span></div>
    </div>

    <div class="ctrl">
      <div class="betrow">
        <button class="btn gold" id="betMinus">BET−</button>
        <div class="seg" id="betSeg">BET 5</div>
        <button class="btn gold" id="betPlus">BET＋</button>
        <button class="btn gold" id="maxBet">MAXBET</button>
      </div>
      <div class="grid3">
        <button class="btn" id="stop1" disabled>STOP①</button>
        <button class="btn" id="stop2" disabled>STOP②</button>
        <button class="btn" id="stop3" disabled>STOP③</button>
      </div>
      <button class="btn blue full" id="startBtn">START</button>
    </div>
  </div>

  <div class="dock"><a class="homeBtn" href="store.html"><span class="icon">🏠</span>景品交換所</a></div>

  <div class="modal" id="modalPay">
    <div class="sheet">
      <h2>配当表</h2>
      <div class="paytable">
        <div class="row"><span>正面顔 ×3</span><span class="mul">BET×6</span></div>
        <div class="row"><span>はむケツ ×3</span><span class="mul">BET×8</span></div>
        <div class="row"><span>ねむねむ ×3</span><span class="mul">BET×5</span></div>
        <div class="row"><span>ごはん ×3</span><span class="mul">BET×5</span></div>
        <div class="row"><span>回し車 ×3</span><span class="mul">BET×7</span></div>
        <div class="row"><span>あくび ×3（レア）</span><span class="mul">BET×10</span></div>
        <div class="row"><span>兄弟 ×3（レア）</span><span class="mul">BET×12</span></div>
      </div>
      <button class="btn blue close" id="closePay">閉じる</button>
    </div>
  </div>

  <div class="modal" id="modalPrizes">
    <div class="sheet">
      <h2>景品一覧（仮）</h2>
      <div class="prizes">
        <div class="row"><span>ハムスター壁紙（HD）</span><span class="mul">500 コイン</span></div>
        <div class="row"><span>ハムスター壁紙（4K）</span><span class="mul">1200 コイン</span></div>
        <div class="row"><span>GIFスタンプ 5種セット</span><span class="mul">800 コイン</span></div>
        <div class="row"><span>着せ替えテーマ（ライト）</span><span class="mul">1000 コイン</span></div>
        <div class="row"><span>着せ替えテーマ（ダーク）</span><span class="mul">1000 コイン</span></div>
        <div class="row"><span>限定称号「回し車王」</span><span class="mul">3000 コイン</span></div>
      </div>
      <a class="btn blue goStore" href="store.html">🏠 景品交換所へ</a>
      <button class="btn close" id="closePrizes">閉じる</button>
    </div>
  </div>

<script>
function computeReelSize(){
  const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 10;
  const root = document.getElementById('reels');
  const w = root.getBoundingClientRect().width || root.clientWidth || 330;
  let col = Math.floor((w - 2*gap) / 3);
  col = Math.max(84, Math.min(col, 160));
  document.documentElement.style.setProperty('--reel-w', col+'px');
  document.documentElement.style.setProperty('--cell', col+'px');
}
window.addEventListener('resize', computeReelSize);
document.addEventListener('DOMContentLoaded', computeReelSize);
window.addEventListener('load', computeReelSize);

const SYMBOLS=[
  {id:'front',img:'assets/ham1.jpg',mul:6},
  {id:'ketsu',img:'assets/ham2.jpg',mul:8},
  {id:'sleep',img:'assets/ham3.jpg',mul:5},
  {id:'eat',img:'assets/ham4.jpg',mul:5},
  {id:'wheel',img:'assets/ham5.jpg',mul:7},
  {id:'yawn',img:'assets/ham6.jpg',mul:10},
  {id:'bros',img:'assets/ham7.jpg',mul:12}
];

let credit=100,bet=5,paid=0;
let spinning=false, settleScheduled=false;
const reelsRoot=document.getElementById('reels');
const creditEl=document.getElementById('credit'),betDispEl=document.getElementById('betDisp'),paidEl=document.getElementById('paid'),betSeg=document.getElementById('betSeg');
const startBtn=document.getElementById('startBtn');
const stopBtns=[document.getElementById('stop1'),document.getElementById('stop2'),document.getElementById('stop3')];

function syncMeters(){creditEl.textContent=credit;document.getElementById('betDisp').textContent=bet;paidEl.textContent=paid;betSeg.textContent=`BET ${bet}`;}
syncMeters();

class Reel{
  constructor(index){
    this.index=index;
    this.el=document.createElement('div'); this.el.className='reel';
    this.strip=document.createElement('div'); this.strip.className='strip'; this.el.appendChild(this.strip);
    for(let r=0;r<3;r++){ SYMBOLS.forEach(sym=>{ const cell=document.createElement('div'); cell.className='cell'; const img=document.createElement('img'); img.src=sym.img; img.alt=sym.id; cell.appendChild(img); this.strip.appendChild(cell); }); }
    this.totalCells=SYMBOLS.length*3;
    this.recalc();
    // 初期状態を「停止済み」にして1回目のSTARTで即回転できるように
    this.pos=Math.round((Math.random()*this.totalH)/this.cellH)*this.cellH % this.totalH;
    this.v=0; this.state='stopped';
    this.strip.style.transform=`translateY(${-this.pos%this.totalH}px)`;
  }
  recalc(){ const cell = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell')) || 110; this.cellH = cell; this.totalH=this.totalCells*this.cellH; }
  start(){ this.v=1800; this.state='spin'; }
  requestStop(){ if(this.state==='spin') this.state='stopping'; }
  update(dt){
    if(this.state==='spin'){ this.pos=(this.pos+this.v*dt)%this.totalH; }
    else if(this.state==='stopping'){ this.v*=Math.pow(0.965,dt*60); this.pos=(this.pos+this.v*dt)%this.totalH; if(this.v<150) this.state='snapping'; }
    else if(this.state==='snapping'){ const off=this.pos%this.cellH; let delta=(off<this.cellH/2?-off:(this.cellH-off))*(1-0.92); this.pos=(this.pos+delta)%this.totalH; const near=Math.abs(this.pos%this.cellH); if(near<0.5||Math.abs(near-this.cellH)<0.5){ this.pos=Math.round(this.pos/this.cellH)*this.cellH; this.v=0; this.state='stopped'; } }
    this.strip.style.transform=`translateY(${-this.pos%this.totalH}px)`;
  }
  isStopped(){ return this.state==='stopped'; }
  visibleIndices(){ const topIdx=Math.floor(this.pos/this.cellH)%this.totalCells; return [topIdx, topIdx+1, topIdx+2].map(i=>(i%this.totalCells)%SYMBOLS.length); }
}
let reels=[];
function buildReels(){ reelsRoot.innerHTML=''; reels=[new Reel(0),new Reel(1),new Reel(2)]; reels.forEach(r=>reelsRoot.appendChild(r.el)); }
document.addEventListener('DOMContentLoaded', buildReels);
window.addEventListener('load', ()=>{ computeReelSize(); reels.forEach(r=>r.recalc()); enableStops(false); startBtn.disabled=false; });

let raf=null,last=0;
function loop(ts){ if(!last) last=ts; const dt=(ts-last)/1000; last=ts; reels.forEach(r=>r.update(dt)); raf=requestAnimationFrame(loop); }
if(!raf){ raf=requestAnimationFrame(loop); }

function enableStops(on){ stopBtns.forEach(b=>b.disabled=!on); }
function allStopped(){ return reels.every(r=>r.isStopped()); }

function startSpin(){
  if(spinning) return;
  if(credit<bet){ alert('コイン不足🥲'); return; }
  credit-=bet; paid=0; syncMeters();
  reels.forEach(r=>r.start());
  startBtn.disabled=true; enableStops(true); spinning=true; settleScheduled=false;
}

function monitorSettle(){
  if(settleScheduled) return;
  settleScheduled=true;
  const tick=()=>{
    if(allStopped()){
      settle();
      settleScheduled=false;
    }else{
      setTimeout(tick,80);
    }
  };
  setTimeout(tick,80);
}

function stopReel(i){
  if(!spinning) return;
  reels[i].requestStop();
  monitorSettle();
}

function settle(){
  enableStops(false);
  startBtn.disabled=false;
  spinning=false;
  const board=Array.from({length:3},()=>Array(3).fill(null));
  for(let c=0;c<3;c++){ const vis=reels[c].visibleIndices(); for(let r=0;r<3;r++) board[r][c]=SYMBOLS[vis[r]].id; }
  const lines=[[[0,0],[0,1],[0,2]],[[1,0],[1,1],[1,2]],[[2,0],[2,1],[2,2]],[[0,0],[1,1],[2,2]],[[2,0],[1,1],[0,2]]];
  let win=0; for(const L of lines){ const ids=L.map(([r,c])=>board[r][c]); if(ids[0]===ids[1] && ids[1]===ids[2]){ const sym=SYMBOLS.find(s=>s.id===ids[0]); win += bet * (sym?.mul ?? 1); } }
  paid=win; if(win>0){ credit+=win; } syncMeters();
}

document.getElementById('stop1').addEventListener('click',()=>stopReel(0));
document.getElementById('stop2').addEventListener('click',()=>stopReel(1));
document.getElementById('stop3').addEventListener('click',()=>stopReel(2));
document.getElementById('betMinus').addEventListener('click',()=>{ if(spinning) return; bet=Math.max(1,bet-1); syncMeters(); });
document.getElementById('betPlus').addEventListener('click',()=>{ if(spinning) return; bet=Math.min(10,bet+1); syncMeters(); });
document.getElementById('maxBet').addEventListener('click',()=>{ if(spinning) return; bet=10; syncMeters(); });
document.getElementById('startBtn').addEventListener('click',startSpin);

const modalPay=document.getElementById('modalPay'), modalPrizes=document.getElementById('modalPrizes');
document.getElementById('openPay').addEventListener('click',()=> modalPay.classList.add('show'));
document.getElementById('closePay').addEventListener('click',()=> modalPay.classList.remove('show'));
modalPay.addEventListener('click',e=>{ if(e.target===modalPay) modalPay.classList.remove('show'); });
document.getElementById('openPrizes').addEventListener('click',()=> modalPrizes.classList.add('show'));
document.getElementById('closePrizes').addEventListener('click',()=> modalPrizes.classList.remove('show'));
modalPrizes.addEventListener('click',e=>{ if(e.target===modalPrizes) modalPrizes.classList.remove('show'); });
</script>
</body>
</html>
